[gd_scene load_steps=6 format=2]

[ext_resource path="res://scenes/map.tscn" type="PackedScene" id=1]
[ext_resource path="res://scenes/truck.tscn" type="PackedScene" id=2]
[ext_resource path="res://scenes/player.tscn" type="PackedScene" id=3]
[ext_resource path="res://scenes/npcsystem.tscn" type="PackedScene" id=4]

[sub_resource type="GDScript" id=1]
script/source = "extends Node

export (int) var enterDistance = 750
var playerInTruck = true
onready var currentPlayerPosition = get_player_pos()

# Called when the node enters the scene tree for the first time.
func _ready():
	$Truck/Camera2D.current = true
	#generate npcs
	$NPCSystem.create_npc(\"guy\", currentPlayerPosition + Vector2(50,50))

# Called every frame. 'delta' is the elapsed time since the previous frame.
func _process(delta):
#	print($Player.position)
#	print($Truck.position)
#	print(($Player.position - $Truck.position).length_squared())
#	print(playerInTruck)

	currentPlayerPosition = get_player_pos()

	# update map
	$Map.playerPosition = currentPlayerPosition

	# Truck enter exit logic
	if Input.is_action_just_pressed('enter-exit'):
		var action = false
		if playerInTruck:
			$Player.global_position = $Truck.global_position
			$Truck.disable_input()
			$Player.visible = true
			action = true
		elif ($Player.position - $Truck.position).length_squared() < enterDistance:
			$Player.visible = false
			$Truck.enable_input()
			action = true
			
		if action:
			playerInTruck = !playerInTruck
			$Truck/Camera2D.current = playerInTruck
			$Player/Camera2D.current = !playerInTruck
			
			
func get_player_pos():
	return $Truck.global_position if playerInTruck else $Player.global_position"

[node name="Node2D" type="Node2D"]

[node name="Node" type="Node" parent="."]
script = SubResource( 1 )

[node name="Map" parent="Node" instance=ExtResource( 1 )]

[node name="Truck" parent="Node" instance=ExtResource( 2 )]

[node name="Camera2D" type="Camera2D" parent="Node/Truck"]
position = Vector2( -50, -50 )

[node name="Player" parent="Node" instance=ExtResource( 3 )]
editor/display_folded = true
visible = false

[node name="Camera2D" type="Camera2D" parent="Node/Player"]

[node name="NPCSystem" parent="Node" instance=ExtResource( 4 )]
